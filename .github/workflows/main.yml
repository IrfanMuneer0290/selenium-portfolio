name: ğŸ›’ DemoBlaze 1% Elite CI Pipeline

on:
  push:
    branches: [ "main" ]
    # PROBLEM: We wasted thousands of dollars in cloud costs running 4-hour suites for README fixes.
    # SOLUTION: At Walmart, I introduced 'Path Filtering' to trigger tests only for functional code.
    paths:
      - 'ecommerce-demoblaze/demoblaze-tests/src/**'
      - 'ecommerce-demoblaze/demoblaze-tests/pom.xml'
      - 'docker-compose.yml'
      - '.github/workflows/main.yml' 
  workflow_dispatch: 

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # IMPACT: Needed for SonarQube/Blame data to track quality trends.

    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: ğŸ—ï¸ Start Docker Selenium Grid
      run: |
        docker compose up -d --wait --wait-timeout 120
        sleep 15  # Extra warmup for Chrome nodes
        echo "ğŸ” Grid health check:"
        curl -f http://localhost:4444/wd/hub/status || echo "Grid warmup..."

    - name: ğŸ§ª Run Maven Tests
      env:
        SPLUNK_TOKEN: ${{ secrets.SPLUNK_TOKEN }}
        RUN_ID: ${{ github.run_id }}
      working-directory: ecommerce-demoblaze/demoblaze-tests
      run: |
        echo "::add-mask::$SPLUNK_TOKEN"
        mkdir -p target/reports logs
        # Added -Duser.dir=$(pwd) to ensure ExtentReports finds the right target path
        mvn clean test -Dheadless=true \
          -Dexecution_env=remote \
          -Dsplunk.token=$SPLUNK_TOKEN \
          -Dreport.dir=target/reports \
          -Duser.dir=$(pwd) \
          -Dmaven.test.failure.ignore=true

    - name: ğŸ§ªğŸ” FINAL DEBUG - Full Test Execution Log
      if: always()
      working-directory: ecommerce-demoblaze/demoblaze-tests
      run: |
        echo "=== TEST DISCOVERY ==="
        find src/test/java -name "*Test.java" | head -3 || echo "âŒ NO TEST CLASSES"
        echo "=== CONFIG LOADED? ==="
        grep -r "CONFIG: Loaded" target/surefire-reports/ || echo "âŒ NO CONFIG LOGS"
        echo "=== SUREFIRE REPORTS ==="
        ls -la target/surefire-reports/ 2>/dev/null || echo "âŒ NO TEST EXECUTION"
        echo "=== EXTENT REPORTS? ==="
        ls -la target/reports/ 2>/dev/null || echo "âŒ NO EXTENT HTML"

    - name: ğŸ” List Generated Files
      if: always()
      working-directory: ecommerce-demoblaze/demoblaze-tests
      run: |
        echo "ğŸ“ Contents of target/:"
        ls -la target/ || echo "target/ not found"
        
        echo "ğŸ“ Contents of target/reports/:"
        if [ -d "target/reports" ]; then
          ls -la target/reports/
        else
          echo "reports/ directory does not exist"
        fi
        
        echo "ğŸ” All HTML files:"
        # FIXED: Added missing closing quotes and proper search pattern
        find target/ -name "*.html"
