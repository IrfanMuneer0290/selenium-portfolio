name: üõí DemoBlaze 1% Elite CI Pipeline

on:
  push:
    branches: [ "main" ]
    paths:
      - 'ecommerce-demoblaze/demoblaze-tests/src/**'
      - 'ecommerce-demoblaze/demoblaze-tests/pom.xml'
      - 'docker-compose.yml'
      - '.github/workflows/main.yml' 
  workflow_dispatch: 

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ‚òï Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: üèóÔ∏è Start Docker Selenium Grid
      run: |
        docker compose up -d --wait --wait-timeout 120
        sleep 15
        echo "üîç Grid health check:"
        curl -f http://localhost:4444/wd/hub/status || echo "Grid warming up..."

    - name: üß™ Run Maven Tests
      env:
        SPLUNK_TOKEN: ${{ secrets.SPLUNK_TOKEN }}
        RUN_ID: ${{ github.run_id }}
      working-directory: ecommerce-demoblaze/demoblaze-tests
      run: |
        echo "::add-mask::$SPLUNK_TOKEN"
        # Ensure directories exist for listeners to write into
        mkdir -p target/reports logs
        
        # IMPACT: Added 'test-compile' to fix 'Listener not found' error.
        # IMPACT: Added -Duser.dir to anchor relative paths in the sub-module.
        mvn clean test-compile test \
          -Dheadless=true \
          -Dexecution_env=remote \
          -Dsplunk.token=$SPLUNK_TOKEN \
          -Dreport.dir=target/reports \
          -Duser.dir=$(pwd) \
          -Dmaven.test.failure.ignore=true

    - name: üìä Upload Test Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: execution-reports
        path: |
          ecommerce-demoblaze/demoblaze-tests/target/surefire-reports/
          ecommerce-demoblaze/demoblaze-tests/target/reports/
        retention-days: 7

    - name: üß™üîç FINAL DEBUG - Locate Reports
      if: always()
      working-directory: ecommerce-demoblaze/demoblaze-tests
      run: |
        echo "=== VERIFYING LISTENER CLASS ==="
        find target/test-classes -name "ExtentReportListener.class" || echo "‚ùå Listener class NOT compiled!"
        
        echo "=== CHECKING FOR ANY HTML REPORT ==="
        find target/ -name "*.html"
        
        echo "=== DIRECTORY VERIFICATION ==="
        ls -la target/surefire-reports/index.html || echo "‚ùå Surefire index missing"
        ls -la target/reports/ || echo "‚ùå Extent folder empty"
